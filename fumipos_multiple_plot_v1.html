<html>
<head>
	<meta http-equiv="Content-Type" charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="../csslib/material_icons.css" charset="utf-8">
	<link rel="stylesheet" href="../csslib/material.indigo-pink.min.css" charset="utf-8">
	<link rel="stylesheet" href="./css/fumipos_plot.css" charset="utf-8">
	<link rel="icon" type="image/png" href="./image/icon.png" sizes="64x64">
	<style type="text/css" id="graph_style"></style>
	
	
	<title>Binary variation & abundance pattern diagrams</title>
</head>

<body>
	
	<span id="tooltip"></span>
	
	<!-- サイドメニュー -->
		<!-- サイドオープン時メインコンテンツを覆う -->
  <div class="overlay" id="js__overlay"></div>
	
	<nav class="side-menu">
		<ul>
			<li><a href="./doc/readme.html" target="_blank">Read me</a></li>
		</ul>
	</nav>

		<!-- 開閉用ボタン -->
	<div class="side-menu-btn" id="js__sideMenuBtn"> 
		<a href="#" id="panel-btn"><span id="panel-btn-icon"></span></a>
	</div>
	
	<!-- Fixed トップメニュー -->
	<div id="fixed-menu">
		<div id="fixed-menu-contents">
			<a href="./index.html" id="home"></a>
			<a href="#" class="menu-btn" id="mainFile_btn">Select File</a>
			<a href="#" class="menu-btn" id="visual_btn">Symbol</a>
			<a href="#" class="menu-btn" id="legend_btn">Legend</a>
			<a href="#" class="menu-btn" id="melting_btn">Simulate</a>
		</div>
	</div>

	<!-- トップメニュー コンテンツ -->
	<div id="mainFile"></div>
	<div id="symbolForm"></div>
	<div id="legend_setting"></div>
	<div id="simulate_setting"></div>

	<!-- Graph Setting menu -->
	<div id="setting_menu">
		<div id="setting_overlay"></div>
	</div>

	<!-- コンテンツ -->
	<div class="wrapper">
		
		<div class="menuSpace"></div>

		<!-- Graph描画域 -->
			<!-- graph area -->
		<div id="graph_area" name="graph" class="clearfix">
			<!--div id="graph">
			</div-->
			
			<!-- graphAppender -->
		 	<div id="graphAppender">
		 		<form class="graphAppender" id="graphApend_button">
					<input id="appendBinary" class="button graphAppender" type="button" value="+ Binary variation" >
					<input id="appendAbundance" class="button graphAppender" type="button" value="+ Abundance pattern">
		 		</form>
		 	</div>
		</div>
		
		<!-- footer -->
		<div class="footer" id="footer"></div>
	</div>
	
	
	<!-- Loading javascript component -->
	<script src="../jslib/jquery-2.2.0.min.js" charset="utf-8"></script>
	<script defer src="../jslib/jquery-ui.min.js" charset="utf-8"></script>
	<script defer src="../jslib/jquery.ui.touch-punch.min.js" charset="utf-8"></script>
	<script src="../jslib/d3.min.js" charset="utf-8"></script>
	<script defer src="../jslib/material.min.js" charset="utf-8"></script>
	<script src="../jslib/CsvFunction.js"></script>
	
	<script src="../multiCrystallization/js/multiCrystallization_v1.3.1.js" charset="utf-8"></script>
		
	<script src="./js/fumipos_Binary.js" charset="utf-8" ></script>
	<script src="./js/fumipos_Abundance.js" charset="utf-8"></script>
	<script src="./js/fumipos_legend_setting.js" charset="utf-8"></script>

	
</body>

<script type="text/javascript">
/* Grobal variables */
	var formDOM=new Array();
	var plotObj=new Array();
	var csvMainObj=new Array();
	var csvRefObj=new Array();
	var csvPartitioningObj=new Array();
	// List of HTML files 
	var loadingHtmlList={
		footer:{
			url:"./fumipos_footer.html",
			target: "#footer",
		},
		fileForm:{
			url:"./form_main_file.html",
			target:"#mainFile",
			button:"#mainFile_btn",
			overlay:"#setting_overlay",
			close:"#close_selectFile",
		},
		visualForm:{
			url:"./form_symbol.html",
			target:"#symbolForm",
			button:"#visual_btn",
			overlay:"#setting_overlay",
			draggable:false,
			close:"#close_symbolForm",
		},
		legendForm:{
			url:"./form_legend.html",
			target:"#legend_setting",
			button:"#legend_btn",
			overlay:"#setting_overlay",
			draggable:false,
			close:"#close_legendForm",
		},
		simulateForm:{
			url:"./form_simulate.html",
			target:"#simulate_setting",
			button:"#melting_btn",
			overlay:"#setting_overlay",
			draggable:false,
			close:"#close_simulateForm",
		}
	};
	
	window.onbeforeunload=function(e){
		return "Unload ?";
	};
	
/* Ajax lording of menu forms */
	for (var key in loadingHtmlList){
		(function(obj){
			$.ajax({
				type: "GET",
				url: obj.url,
				cache: true,
				async: false,
				dataType: "html",
				success: function(data){
					$(obj.target).html($(data)).trigger("create");
				},
				error: function(){
					alert("Failed to load html: "+obj.url);
				}
			});
			
			if (obj.button){
				$(function() {
  				$(obj.button).click(function(){
  		  		$(obj.target).fadeIn();
  	  			$(obj.overlay).fadeIn();
  	  			return false;
  				});
				});
				$(obj.overlay).click(function(){
					$(obj.overlay).fadeOut();
					$(obj.target).fadeOut();
				});
				$(obj.close).click(function(){
					$(obj.overlay).fadeOut();
					$(obj.target).fadeOut();
				});
			};
			
			if (obj.draggable){
				$(function(){
					$(obj.target).draggable({
						cursor: "move"
					});
				});
			};
		})(loadingHtmlList[key]);
	};
	
	/* form にマウスイベントを設定 */
	d3.select("#symbolForm").select("form")
		.attr("onchange","replotGraphsObj(csvMainObj,csvRefObj,formDOM,plotObj)");
	
	d3.select("#simulate_setting").select("form")
		.attr("onchange","replotGraphsObj(csvMainObj,csvRefObj,formDOM,plotObj)");

/* グラフを並び替えられるようにする */
	// jQuery-UI Sortable 
	$(function(){
		if (window.matchMedia('(max-width:1024px)').matches){
	
		}else{
			$("#graph_area").sortable({
				cursor: "move",
				opacity: 0.7,
			});
			//$("#graph").disableSelection();
		}
	});
	

/* GraphAppender */
	GraphAppender=function(graphAreaID){
		this.graphArea=d3.select(graphAreaID);
		this.graphNumCounter=0;
		this.binaryNumCounter=0;
		this.abundanceNumCounter=0;
		this.menuContent=new Array();
		this.menuContent=["save","setting","delete"];
	};
	
	GraphAppender.prototype.setGraph=function(graphType){
		if (graphType == "binary"){
			var graphTypeString="Binary";
			var formURL="./form_Binary.html";
			var graphNum=this.binaryNumCounter;
			this.binaryNumCounter=this.binaryNumCounter+1;
			var Constructor=Binary;
			
		}else if (graphType == "abundance"){
			graphTypeString="Abundance";
			formURL="./form_abundance.html";
			graphNum=this.abundanceNumCounter;
			this.abundanceNumCounter=this.abundanceNumCounter+1;
			Constructor=Abundance;
		};
		
		/* Create graph & menu rapper */
		this.graphArea.insert("div","div#graphAppender")
				.attr("class","wrapper"+graphTypeString+" "+graphTypeString+graphNum);
		
		/* Create uncountable list */
		d3.select("div.wrapper"+graphTypeString+"."+graphTypeString+graphNum).append("div")
				.attr("class","nav_"+graphTypeString+graphNum)
				.append("ul");
				
		/* Create list menu */
		var menuDOM=d3.select("div.nav_"+graphTypeString+graphNum).select("ul").selectAll("li").data(this.menuContent);
			
		/* Append graph button */
		menuDOM.enter().append("li")
				.attr("class",function(d){return "nav_"+d+graphNum;})
				.append("a")
					.attr("id",function(d){return "nav_"+d+"_"+graphTypeString+graphNum;})
					.attr("class",function(d){return "nav_"+d;});
		
				
		/*  Set open event for menu */
		var num=graphNum;
		$("a#nav_setting_"+graphTypeString+graphNum).click(function(){
			$("div.wrapper"+graphTypeString+"."+graphTypeString+num).addClass("active");
			$("div#setting_overlay").fadeIn();
			$("div#form"+graphTypeString+num).fadeIn();
			$("div#form"+graphTypeString+num+" form input")[0].focus();
		});
		
		//
		//
		/* set save as image event */
		//
		//
		
		$("a#nav_save_"+graphTypeString+graphNum).click(function(){
		
			var svg=d3.select(".graph"+graphTypeString+"."+graphTypeString+num).select("svg");
			
			var commonStyle=document.getElementById("graph_style");
			var legendStyle=document.getElementById("legendStyle");
			
			var styleText =  commonStyle.innerHTML + legendStyle.innerHTML ;
			
			svg.insert("style","g").attr("type","text/css").text(styleText);
			
			svg=d3.select(".graph"+graphTypeString+"."+graphTypeString+num).select("svg");
			var svgDOM=svg[0][0];
			
			var canvas=document.createElement("canvas");
			var svgData = new XMLSerializer().serializeToString(svgDOM);
			
			
			canvas.width = svgDOM.width.baseVal.value;
			canvas.height = svgDOM.height.baseVal.value;
			
			var ctx=canvas.getContext("2d");
			
			// 背景をwhiteで塗りつぶしておく
			ctx.rect(0,0,canvas.width,canvas.height);
			ctx.fillStyle="white";
			ctx.fill();

			var image=new Image;
			image.onload=function(){
				ctx.drawImage(image,0,0);
				// Optional: 自動でダウンロードさせる場合
				
				var xName=d3.select(".graph"+graphTypeString+"."+graphTypeString+num).select("text.xlabel").text();
				var yName=d3.select(".graph"+graphTypeString+"."+graphTypeString+num).select("text.ylabel").text();
				
				xName=xName.replace(/\//g,"_");
				xName=xName.replace(/#/g,"N");
				xName=xName.replace(/[\s\:\*\"\'\<\>\?\|\\]/g,""); //"
				yName=yName.replace(/\//g,"_");
				yName=yName.replace(/#/g,"N");
				yName=yName.replace(/[\s\:\*\"\'\<\>\?\|\\]/g,""); //"
				
				d3.select("body").append("a")
					.attr("id","image-file")
					.attr("class","hidden")
					.attr("type","application/octet-stream")
					.attr("href",canvas.toDataURL("image/png"))
					.attr("download",xName+"-vs-"+yName+".png")
					.text("Download as Image")
				
				//$("body").append("<a id='image-file' class='hidden' type='application/octet-stream' href='"+ canvas.toDataURL("image/png") + "' download='graph.png'>Donload Image</a>")
				$("#image-file")[0].click();
				
				$("canvas").remove();
				$("#image-file").remove();
				
				svg.selectAll("style").remove();
			}
			
			image.src="data:image/svg+xml;charset=utf-8;base64,"+ btoa(unescape(encodeURIComponent(svgData))); 
			
		});
		
		//
		/*  Set delete event */
		//
		
		$("a#nav_delete_"+graphTypeString+graphNum).click(function(){
			$("div#form"+graphTypeString+num).remove();
			$("div.wrapper"+graphTypeString+"."+graphTypeString+num).remove();
		});
		
		//
		/* Create setting form */
		//
		
		d3.select("div#setting_menu").append("div")
			.attr("class","form"+graphTypeString)
			.attr("id","form"+graphTypeString+graphNum);
			
		$.ajax({
			type: "GET",
			url: formURL,
			cache: false, //キャッシュを利用するか（お好みで）
			async: false, //非同期で読み込むか（お好みで）
			dataType: "html",
			success: function(data){
				$("div#form"+graphTypeString+graphNum).append($(data)).trigger('create'); 
			},
			error: function(){
				console.log("Failed to load form")
			}
		});
	
		/* Set close event for manu */
		$("div#form"+graphTypeString+graphNum+" a.close_button").click(function(){
			$("div.wrapper"+graphTypeString+"."+graphTypeString+num).removeClass("active");
			$("div#setting_overlay").fadeOut();
			$("div#form"+graphTypeString+num).fadeOut();
			
		});
		
		$("div#setting_overlay").click(function(){
			$("div.wrapper"+graphTypeString+"."+graphTypeString+num).removeClass("active");
			$("div#setting_overlay").fadeOut();
			$("div#form"+graphTypeString+num).fadeOut();

		});
			
		/* Create graph area*/
		d3.select("div.wrapper"+graphTypeString+"."+graphTypeString+graphNum).append("div")
			.attr("class","graph"+graphTypeString+" "+graphTypeString+graphNum);
		if (graphType == "binary"){
			/* Create setting form (Binary)*/
			if (window.matchMedia('(max-width:1024px)').matches){
				d3.select("div#formBinary"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-slider").attr("value","0.8");
				d3.select("div#formBinary"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-textfield__input").attr("value","0.8");
			}else{
				d3.select("div#formBinary"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-slider").attr("value","0.3");
				d3.select("div#formBinary"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-textfield__input").attr("value","0.8");
			}
		}else if (graphType == "abundance"){
			if (window.matchMedia('(max-width:1024px)').matches){
				d3.select("div#formAbundance"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-slider").attr("value","0.8");
				d3.select("div#formAbundance"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-textfield__input").attr("value","0.8");
			}else{
				d3.select("div#formAbundance"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-slider").attr("value","0.5");
				d3.select("div#formAbundance"+graphNum).select("div.imageInput__"+graphTypeString).select("input.mdl-textfield__input").attr("value","0.8");
			}
		};

		/* DOMを再解釈 */
		componentHandler.upgradeDom();
		
		/* Initialize graph area */
		formDOM[this.graphNumCounter]=$('#form'+graphTypeString+graphNum+' > form');

		plotObj[this.graphNumCounter]=new Constructor("div.graph"+graphTypeString+"."+graphTypeString+graphNum,formDOM[this.graphNumCounter][0],plotObj);
	
		//console.log(formDOM[this.graphNumCounter][0])
		/* Add eventListenor*/
		d3.select("div#form"+graphTypeString+graphNum).select("form")
				.attr("onchange","plotObj["+this.graphNumCounter+"].replot(csvMainObj,csvRefObj,formDOM["+this.graphNumCounter+"][0]);toggleVisibility()");

		$("a#nav_setting_"+graphTypeString+graphNum).click();

		this.graphNumCounter=this.graphNumCounter+1;
	};
	
/* GraphApenderのインスタンス生成 */
	(function(){
		var graphAppend=new GraphAppender("#graph_area");
		document.getElementById("appendBinary").onclick=function(){
			graphAppend.setGraph("binary");
		};
		document.getElementById("appendAbundance").onclick=function(){	graphAppend.setGraph("abundance");
		};
	})();
	

// _/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/

	
/* ファイル読み込み */
	/* Test data for plot */
	document.getElementById("use_test_data").onclick=function(ev){
		var data = new XMLHttpRequest();
		var url="./data/lava_compositions.csv"
		data.open("GET",url,false);
		data.send(null);
		csvMainObj=creatCsvObject(data.responseText);
		
		var refData = new XMLHttpRequest();
		refData.open("GET","./data/Refferencial_abundance.csv",false);
		refData.send(null);
		csvRefObj=creatCsvObject(refData.responseText);
		replotGraphsObj(csvMainObj,csvRefObj,formDOM,plotObj);
		d3.select("#selectedMainFile").text(url);
	};
	
	/* csvMainObj にメインデータファイルの内容を読み込み*/
	document.getElementById("selectFileMain").onchange=function(ev){
		var file=ev.target.files;
		var reader=new FileReader();
		
		var refData = new XMLHttpRequest();
		refData.open("GET","./data/Refferencial_abundance.csv",false);
		refData.send(null);
		csvRefObj=creatCsvObject(refData.responseText);
		
		reader.readAsText(file[0]);
		//console.log(file)
		reader.onload=function(ev){
			csvMainObj=creatCsvObject(reader.result);
			
			replotGraphsObj(csvMainObj,csvRefObj,formDOM,plotObj);
		};
		
		for (var i=0; i<file.length; i++){
			d3.select("#selectedMainFile").text(file[i].name+"\n");
		}
	};
	
	/* csvPartitioningObjにPartitioning coeffecient fileを読み込み	*/
	document.getElementById("selectMeltingFile").onchange=function(evt){
		var file=evt.target.files;
		var reader=new FileReader();
		reader.readAsText(file[0]);
		
		reader.onload=function(ev){
			csvPartitioningObj=creatCsvObject(reader.result);
			
			/* Form melting のテーブルに結果を表示*/
			d3.select("div#simulatePhase").selectAll("tr.data").remove();
			
			var tableDOM=d3.select("div#simulatePhase").select("tbody").selectAll("tr.data").data(csvPartitioningObj);
			
			tableDOM.exit().remove();
			tableDOM.enter().append("tr")
				.attr("class",function(d){return "data "+d.value["phase"];})
				
			var tableRow=d3.select("div#simulatePhase").selectAll("tr.data").data(csvPartitioningObj);
			tableRow.append("th")
				.attr("class",function(d){return "phase "+d.value["phase"];})
				.text(function(d){return d.value["phase"];});
				
			tableRow.append("td").append("input")
				.attr("id",function(d){return "initial_"+d.value["phase"];})
				.attr("type","text")
				.attr("size","10")
				.attr("value","0");
			tableRow.append("td").append("input")
				.attr("id",function(d){return "reaction_"+d.value["phase"];})
				.attr("type","text")
				.attr("size","10")
				.attr("value","0");
			
		};
		d3.select("#partitioningFile").text(file[0].name);
	};


/* サイドメニュー動作 */

$(function() {
	var $body = $('body');
  $("#panel-btn").click(function() {
    $body.toggleClass('side-open');
    $('#js__overlay').on('click', function () {
      $body.removeClass('side-open');
      $("#panel-btn-icon").toggleClass("close");
    	return false;
     
    });
    $("#panel-btn-icon").toggleClass("close");
    return false;
  });
});


</script>
</html>